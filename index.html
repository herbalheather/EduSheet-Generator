<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSheet Generator - Mama Said This</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pristinejs@2.0.0/dist/pristine.min.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fdcb6e;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card: rgba(255, 255, 255, 0.95);
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --error: #e74c3c;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .back-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        .back-btn:hover { background: #5a4fcf; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab-btn.active { background: var(--primary); transform: scale(1.05); }
        .tab-btn:hover { background: #9f8cf6; }
        section {
            display: none;
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        section.active { display: block; }
        @media (max-width: 768px) {
            section { padding: 20px; }
            .tabs { justify-content: center; }
        }
        h1, h2, h3 { color: var(--primary); }
        .subtitle { font-style: italic; color: #666; margin-bottom: 30px; }
        #worksheetForm {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            #worksheetForm { grid-template-columns: 1fr; }
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s;
        }
        select:focus { border-color: var(--primary); outline: none; }
        select[aria-invalid="true"] { border-color: var(--error); }
        .error-msg {
            color: var(--error);
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }
        .error-msg.show { display: block; }
        .preview {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid var(--accent);
            min-height: 80px;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        button:hover:not(:disabled) { background: #5a4fcf; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .output {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 600px;
            overflow-y: auto;
            border: 2px solid var(--accent);
        }
        .output h3 { color: var(--primary); }
        .problem { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .answer-key { margin-top: 20px; background: #e3f2fd; padding: 15px; border-radius: 5px; }
        .tips {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }
        .tips ul {
            list-style: none;
            padding: 0;
        }
        .tips li {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            box-shadow: var(--shadow);
            position: relative;
            padding-left: 40px;
        }
        .tips li::before {
            content: "üí°";
            position: absolute;
            left: 10px;
            top: 10px;
        }
        .quiz-q {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .quiz-option {
            display: block;
            margin: 8px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .quiz-option:hover { background: #e3f2fd; }
        .quiz-option input:checked + label { background: var(--secondary); color: white; }
        #results {
            display: none;
            padding: 20px;
            background: var(--accent);
            border-radius: 10px;
            text-align: center;
        }
        #search {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        #search:focus { border-color: var(--primary); outline: none; }
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        @media (max-width: 768px) {
            .library-grid { grid-template-columns: 1fr; }
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-5px); }
        .card h4 { color: var(--primary); margin-bottom: 10px; }
        .card p { color: #666; margin-bottom: 15px; }
        .card iframe {
            width: 100%;
            height: 200px;
            border: none;
            border-radius: 10px;
        }
        .card a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .card a:hover { text-decoration: underline; }
        .tabs[role="tablist"] .tab-btn[role="tab"] { }
    </style>
</head>
<body>
    <nav>
        <button class="back-btn" aria-label="Back to Chooser" onclick="window.location.href='https://edusheet-chooser.pages.dev/'">‚Üê Back to Chooser</button>
        <button class="back-btn" aria-label="Go to Home" onclick="window.location.href='https://mamasaid-this.pages.dev/'">üè† Home</button>
    </nav>
    <div class="tabs" role="tablist">
        <button class="tab-btn active" role="tab" aria-selected="true" aria-controls="generator" onclick="showSection('generator')">Generator üìù</button>
        <button class="tab-btn" role="tab" aria-selected="false" aria-controls="assessment" onclick="showSection('assessment')">Assessment üß†</button>
        <button class="tab-btn" role="tab" aria-selected="false" aria-controls="library" onclick="showSection('library')">Library üìö</button>
    </div>

    <section id="generator" role="tabpanel" class="active">
        <h1>EduSheet Generator</h1>
        <p class="subtitle">No logins, instant fun! Create custom K-6 worksheets with themes. üéâ</p>
        <form id="worksheetForm">
            <div>
                <label for="grade">Grade <span style="color:red;">*</span> <span aria-hidden="true">(required)</span></label>
                <select id="grade" required aria-required="true" aria-describedby="grade-error">
                    <option value="">Select Grade</option>
                    <option value="K">K</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
                <div class="error-msg" id="grade-error">Hey, let's pick a grade to get started! üìö</div>
            </div>
            <div>
                <label for="subject">Subject <span style="color:red;">*</span> <span aria-hidden="true">(required)</span></label>
                <select id="subject" required aria-required="true" aria-describedby="subject-error">
                    <option value="">Select Subject</option>
                    <option value="Math">Math ‚ûï</option>
                    <option value="Science">Science üî¨</option>
                    <option value="Reading">Reading üìñ</option>
                </select>
                <div class="error-msg" id="subject-error">What subject sparks joy today? Choose one! ‚ú®</div>
            </div>
            <div>
                <label for="type">Type <span style="color:red;">*</span> <span aria-hidden="true">(required)</span></label>
                <select id="type" required aria-required="true" aria-describedby="type-error">
                    <option value="">Select Type</option>
                    <option value="Word Search">Word Search üîç</option>
                    <option value="Quiz">Quiz ‚ùì</option>
                    <option value="Math Practice">Math Practice üßÆ</option>
                </select>
                <div class="error-msg" id="type-error">Pick a fun activity type for the worksheet! üéØ</div>
            </div>
            <div>
                <label for="theme">Theme</label>
                <select id="theme" aria-describedby="theme-help">
                    <option value="">Select Theme</option>
                    <option value="Space">Space üöÄ</option>
                    <option value="Animals">Animals ü¶Å</option>
                    <option value="Undersea">Undersea üêã</option>
                    <option value="Dinos">Dinos ü¶ï</option>
                    <option value="Nature">Nature üå≥</option>
                    <option value="Transport">Transport üöó</option>
                </select>
                <div id="theme-help" class="sr-only">Optional: Adds a fun theme to your worksheet.</div>
            </div>
            <div>
                <label for="difficulty">Difficulty</label>
                <select id="difficulty" aria-describedby="difficulty-help">
                    <option value="">Select Difficulty</option>
                    <option value="Easy">Easy üòä</option>
                    <option value="Medium">Medium ‚öñÔ∏è</option>
                    <option value="Pro">Pro üî•</option>
                </select>
                <div id="difficulty-help" class="sr-only">Optional: Adjusts the challenge level.</div>
            </div>
        </form>
        <div id="preview" class="preview" role="status" aria-live="polite">Select your options to see a live preview! üëÄ</div>
        <button id="generateBtn" aria-label="Generate the worksheet" onclick="generateWorksheet()" disabled>Generate Worksheet ‚ú®</button>
        <div id="output" class="output" role="region" aria-label="Generated worksheet content"></div>
        <button id="pdfBtn" aria-label="Download as PDF" onclick="downloadPDF()" style="display:none;">Download PDF üìÑ</button>
        <button aria-label="Save current template settings" onclick="saveTemplate()">Save Template üíæ</button>
        <div class="tips">
            <h3>Quick Tips:</h3>
            <ul>
                <li>Start with Easy for K-2, Pro for 5-6 challenges!</li>
                <li>Themes make learning fun‚Äîtry Space for math rockets! üöÄ</li>
                <li>Answer keys are included for quick checks.</li>
                <li>Use the preview to tease before generating the full sheet.</li>
                <li>Saved templates load automatically next time. üéØ</li>
            </ul>
        </div>
    </section>

    <section id="assessment" role="tabpanel">
        <h2>Learning Style Quiz</h2>
        <p>Answer these 5 questions to discover your child's learning style: Visual üëÅÔ∏è, Auditory üëÇ, or Kinesthetic ‚úã. Recommendations tied to themes!</p>
        <div id="quiz" role="form">
            <fieldset>
                <legend class="sr-only">Question 1</legend>
                <div class="quiz-q">
                    <h3>1. How does your child best remember information?</h3>
                    <label class="quiz-option"><input type="radio" name="q1" value="visual" required> By seeing pictures or diagrams</label>
                    <label class="quiz-option"><input type="radio" name="q1" value="auditory"> By hearing explanations</label>
                    <label class="quiz-option"><input type="radio" name="q1" value="kinesthetic"> By doing hands-on activities</label>
                </div>
            </fieldset>
            <fieldset>
                <legend class="sr-only">Question 2</legend>
                <div class="quiz-q">
                    <h3>2. In class, your child prefers...</h3>
                    <label class="quiz-option"><input type="radio" name="q2" value="visual"> Watching videos or demos</label>
                    <label class="quiz-option"><input type="radio" name="q2" value="auditory"> Listening to discussions</label>
                    <label class="quiz-option"><input type="radio" name="q2" value="kinesthetic" required> Group projects or experiments</label>
                </div>
            </fieldset>
            <fieldset>
                <legend class="sr-only">Question 3</legend>
                <div class="quiz-q">
                    <h3>3. For studying, your child likes...</h3>
                    <label class="quiz-option"><input type="radio" name="q3" value="visual"> Highlighting notes with colors</label>
                    <label class="quiz-option"><input type="radio" name="q3" value="auditory"> Reading aloud</label>
                    <label class="quiz-option"><input type="radio" name="q3" value="kinesthetic"> Walking while reviewing</label>
                </div>
            </fieldset>
            <fieldset>
                <legend class="sr-only">Question 4</legend>
                <div class="quiz-q">
                    <h3>4. New skills are easiest when...</h3>
                    <label class="quiz-option"><input type="radio" name="q4" value="visual"> Shown visually step-by-step</label>
                    <label class="quiz-option"><input type="radio" name="q4" value="auditory"> Explained verbally</label>
                    <label class="quiz-option"><input type="radio" name="q4" value="kinesthetic"> Practiced physically</label>
                </div>
            </fieldset>
            <fieldset>
                <legend class="sr-only">Question 5</legend>
                <div class="quiz-q">
                    <h3>5. Your child enjoys...</h3>
                    <label class="quiz-option"><input type="radio" name="q5" value="visual"> Drawing or maps</label>
                    <label class="quiz-option"><input type="radio" name="q5" value="auditory"> Storytelling or music</label>
                    <label class="quiz-option"><input type="radio" name="q5" value="kinesthetic"> Building or sports</label>
                </div>
            </fieldset>
        </div>
        <button id="quizBtn" aria-label="Submit quiz answers" onclick="handleQuiz()" disabled>Submit Quiz üìä</button>
        <div class="error-msg" id="quiz-error" style="text-align: center; margin-top: 10px;">Oops! Answer all questions to see the results. Let's complete the quiz! üß©</div>
        <div id="results" role="status" aria-live="polite"></div>
    </section>

    <section id="library" role="tabpanel">
        <h2>Resource Library</h2>
        <p>Curated free resources for K-6 learning. Search by theme or subject! üîç</p>
        <label for="search" class="sr-only">Search resources</label>
        <input type="text" id="search" placeholder="Search (e.g., space math)" oninput="filterResources()" aria-label="Search library resources">
        <div class="library-grid" id="resources" role="list">
            <div class="card" data-tags="math space" role="listitem">
                <h4>Khan Academy: Early Math in Space</h4>
                <p>Interactive addition with rocket themes for K-2.</p>
                <iframe src="https://www.khanacademy.org/math/early-math/cc-early-math-add-sub-topic/cc-early-math-add-sub-intro/v/add-within-10" title="Khan Academy Early Math" allowfullscreen></iframe>
                <a href="https://www.khanacademy.org/math/early-math" target="_blank" rel="noopener">More Khan Math</a>
            </div>
            <div class="card" data-tags="science animals" role="listitem">
                <h4>YouTube: Animal Habitats</h4>
                <p>Fun video on lions and ecosystems for grades 1-3.</p>
                <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" title="Animal Habitats Video" allowfullscreen></iframe>
                <a href="https://www.youtube.com/results?search_query=animal+habitats+kids" target="_blank" rel="noopener">More Videos</a>
            </div>
            <div class="card" data-tags="reading undersea" role="listitem">
                <h4>TED-Ed: Ocean Riddles</h4>
                <p>Riddle about whales and sea life for reading comprehension.</p>
                <iframe src="https://www.youtube.com/embed/YytHuow4VnU" title="TED-Ed Sea Monster Riddle" allowfullscreen></iframe>
                <a href="https://ed.ted.com/lessons?category=reading" target="_blank" rel="noopener">TED-Ed Reading</a>
            </div>
            <div class="card" data-tags="math dinos" role="listitem">
                <h4>Khan: Dino Counting</h4>
                <p>Subtraction practice with dinosaur bones, grades 2-4.</p>
                <iframe src="https://www.khanacademy.org/math/cc-second-grade-math/cc-2nd-add-sub-topic/cc-2nd-add-sub-word-problems/v/word-problem-subtracting-3" title="Khan Academy Dino Counting" allowfullscreen></iframe>
                <a href="https://www.khanacademy.org/math/cc-second-grade-math" target="_blank" rel="noopener">Grade 2 Math</a>
            </div>
            <div class="card" data-tags="science nature" role="listitem">
                <h4>YouTube: Plant Life Cycle</h4>
                <p>Animated science on trees and nature for K-3.</p>
                <iframe src="https://www.youtube.com/embed/7viA16-J2K0" title="Plant Life Cycle Animation" allowfullscreen></iframe>
                <a href="https://www.youtube.com/results?search_query=plant+life+cycle+kids" target="_blank" rel="noopener">More Nature</a>
            </div>
            <div class="card" data-tags="reading transport" role="listitem">
                <h4>Duolingo ABC: Vehicle Stories</h4>
                <p>Literacy app intro with car adventures for K-1.</p>
                <p>Download the app for interactive reading.</p>
                <a href="https://www.duolingo.com/abc" target="_blank" rel="noopener">Duolingo ABC</a>
            </div>
            <div class="card" data-tags="quiz space science" role="listitem">
                <h4>TED-Ed: Space Junk Riddle</h4>
                <p>Quiz-style riddle on planets for grades 3-5.</p>
                <iframe src="https://www.youtube.com/embed/Fj2hTS5Kjyw" title="TED-Ed Dark Matter Fuel Riddle" allowfullscreen></iframe>
                <a href="https://ed.ted.com/lessons?category=science" target="_blank" rel="noopener">TED-Ed Science</a>
            </div>
            <div class="card" data-tags="math animals" role="listitem">
                <h4>Khan: Animal Patterns</h4>
                <p>Geometry with animal shapes, grades 4-6.</p>
                <iframe src="https://www.khanacademy.org/math/geometry-home/geometry-patterns" title="Khan Academy Geometry Patterns" frameborder="0" allowfullscreen></iframe>
                <a href="https://www.khanacademy.org/math/geometry-home" target="_blank" rel="noopener">Geometry Unit</a>
            </div>
            <div class="card" data-tags="reading dinos" role="listitem">
                <h4>YouTube: Dino Tales</h4>
                <p>Reading aloud stories about T-Rex for K-2.</p>
                <iframe src="https://www.youtube.com/embed/ycQ0k7yVERE" title="Dinosaur Musical Stories" allowfullscreen></iframe>
                <a href="https://www.youtube.com/results?search_query=dinosaur+stories+kids" target="_blank" rel="noopener">Storytime</a>
            </div>
            <div class="card" data-tags="science undersea" role="listitem">
                <h4>Khan: Ocean Life</h4>
                <p>Biology basics on whales, grades 3-5.</p>
                <iframe src="https://www.khanacademy.org/science/biology" title="Khan Academy Biology" frameborder="0" allowfullscreen></iframe>
                <a href="https://www.khanacademy.org/science" target="_blank" rel="noopener">Science Units</a>
            </div>
            <div class="card" data-tags="math nature" role="listitem">
                <h4>YouTube: Nature Math</h4>
                <p>Fractions with fruits and trees.</p>
                <iframe src="https://www.youtube.com/embed/p33BYf1NDAE" title="Fractions for Kids" allowfullscreen></iframe>
                <a href="https://www.youtube.com/results?search_query=nature+math+kids" target="_blank" rel="noopener">Videos</a>
            </div>
            <div class="card" data-tags="reading transport" role="listitem">
                <h4>TED-Ed: Transport Puzzles</h4>
                <p>Riddles on cars and travel for reading.</p>
                <iframe src="https://www.youtube.com/embed/ADR7dUoVh_c" title="TED-Ed River Crossing Riddle" allowfullscreen></iframe>
                <a href="https://ed.ted.com/lessons?category=ela" target="_blank" rel="noopener">ELA Riddles</a>
            </div>
        </div>
    </section>

    <style>
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>

    <script>
        const App = {
            elements: {
                form: document.getElementById('worksheetForm'),
                grade: document.getElementById('grade'),
                subject: document.getElementById('subject'),
                type: document.getElementById('type'),
                theme: document.getElementById('theme'),
                difficulty: document.getElementById('difficulty'),
                preview: document.getElementById('preview'),
                generateBtn: document.getElementById('generateBtn'),
                output: document.getElementById('output'),
                pdfBtn: document.getElementById('pdfBtn')
            },
            state: {
                selectedTheme: '',
                quizAnswers: {}
            },
            themes: {
                Space: ['ROCKET', 'PLANET', 'STAR', 'MOON', 'GALAXY'],
                Animals: ['LION', 'ELEPHANT', 'ZEBRA', 'GIRAFFE', 'TIGER'],
                Undersea: ['WHALE', 'SHARK', 'OCTOPUS', 'SEAHORSE', 'CORAL'],
                Dinos: ['TREX', 'STEGO', 'TRICER', 'RAPTOR', 'BRONTO'],
                Nature: ['TREE', 'FLOWER', 'RIVER', 'MOUNTAIN', 'FOREST'],
                Transport: ['CAR', 'TRAIN', 'PLANE', 'BOAT', 'BUS']
            },
            mathOps: {
                K: { easy: ['add'], medium: ['add', 'sub'], pro: ['add', 'sub'] },
                1: { easy: ['add'], medium: ['add', 'sub'], pro: ['add', 'sub', 'mul'] },
                2: { easy: ['add', 'sub'], medium: ['add', 'sub', 'mul'], pro: ['add', 'sub', 'mul', 'div'] },
                3: { easy: ['mul'], medium: ['mul', 'div'], pro: ['add', 'sub', 'mul', 'div'] },
                4: { easy: ['mul', 'div'], medium: ['add', 'sub', 'mul', 'div'], pro: ['add', 'sub', 'mul', 'div'] },
                5: { easy: ['div'], medium: ['mul', 'div'], pro: ['fractions'] },
                6: { easy: ['mul', 'div'], medium: ['add', 'sub', 'mul', 'div'], pro: ['decimals'] }
            },
            init: function() {
                this.pristine = new Pristine(this.elements.form, {
                    class: 'invalid',
                    errorClass: 'invalid',
                    successClass: 'valid',
                    errorTextParent: 'div',
                    errorTextClass: 'error-msg',
                    message: function(el) {
                        return el.dataset.pristineError || 'This field is required.';
                    }
                });
                this.bindEvents();
                this.loadTemplate();
                this.updatePreview();
                showSection('generator');
                this.validateQuiz();
            },
            bindEvents: function() {
                this.elements.form.addEventListener('submit', (e) => e.preventDefault());
                [this.elements.grade, this.elements.subject, this.elements.type, this.elements.theme, this.elements.difficulty].forEach(el => {
                    el.addEventListener('change', () => {
                        this.pristine.validate(el);
                        this.saveTemplate();
                        this.updatePreview();
                    });
                });
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', () => { 
                        this.state.quizAnswers[radio.name] = radio.value; 
                        this.validateQuiz();
                    });
                });
                document.getElementById('search').addEventListener('input', (e) => {
                    e.target.value = e.target.value.trim();
                    filterResources();
                });
            },
            updatePreview: function() {
                const grade = this.elements.grade.value;
                const subject = this.elements.subject.value;
                const type = this.elements.type.value;
                const theme = this.elements.theme.value;
                const difficulty = this.elements.difficulty.value;
                let previewText = 'Select your options to see a live preview! üëÄ';
                if (grade && subject && type) {
                    if (type === 'Math Practice') {
                        const themeWord = this.themes[theme]?.[0] || 'Item';
                        previewText = `${theme || 'General'} theme: ${difficulty || 'Easy'} ${grade} math - e.g., ${themeWord} 5 + 7 = ? ${theme ? 'üöÄ' : ''}`;
                    } else if (type === 'Word Search') {
                        const words = this.themes[theme]?.slice(0, 3).join(', ') || 'WORD, FUN, PLAY';
                        previewText = `Snippet grid with words like: ${words} üîç`;
                    } else if (type === 'Quiz') {
                        previewText = `Sample: What's a cool ${ (theme || 'general').toLowerCase() } ${subject.toLowerCase()} fact? Options below ‚ùì`;
                    }
                }
                this.elements.preview.textContent = previewText;
                this.elements.generateBtn.disabled = !this.pristine.validate();
            },
            generateWorksheet: function() {
                if (!this.pristine.validate()) {
                    alert('Please complete all required fields with valid selections before generating your worksheet! üéâ');
                    return;
                }
                const { grade, subject, type, theme, difficulty } = {
                    grade: this.elements.grade.value,
                    subject: this.elements.subject.value,
                    type: this.elements.type.value,
                    theme: this.elements.theme.value || 'General',
                    difficulty: this.elements.difficulty.value || 'Easy'
                };
                let content = `<h3>${type} Worksheet: ${grade} ${subject} - ${theme} Theme (${difficulty})</h3>`;
                let answers = [];
                if (type === 'Math Practice') {
                    const ops = this.mathOps[grade]?.[difficulty.toLowerCase()] || ['add'];
                    const themeWords = this.themes[theme]?.[0] || 'Item';
                    const numProblems = difficulty === 'Easy' ? 5 : difficulty === 'Medium' ? 8 : 10;
                    for (let i = 0; i < numProblems; i++) {
                        const op = ops[Math.floor(Math.random() * ops.length)];
                        const a = Math.floor(Math.random() * (grade > '2' ? 20 : 10)) + 1;
                        const b = Math.floor(Math.random() * (grade > '2' ? 20 : 10)) + 1;
                        let problem = `${themeWords} ${a} ${op === 'add' ? '+' : op === 'sub' ? '-' : op === 'mul' ? '√ó' : '√∑'} ${b} = ?`;
                        let ans;
                        if (op === 'add') ans = a + b;
                        else if (op === 'sub') ans = Math.max(a - b, 0);
                        else if (op === 'mul') ans = a * b;
                        else if (op === 'div') { 
                            ans = b; 
                            problem = `${themeWords} √∑ ${b} = ${a} (√ó${a})`; 
                        }
                        content += `<div class="problem">${problem}</div>`;
                        answers.push(`${i+1}. ${ans}`);
                    }
                } else if (type === 'Word Search') {
                    const words = this.themes[theme]?.slice(0, 5) || ['WORD', 'SEARCH', 'FUN', 'KIDS', 'LEARN'];
                    const size = difficulty === 'Easy' ? 8 : difficulty === 'Medium' ? 10 : 12;
                    let grid = this.generateGrid(words, size);
                    content += `<p>Find these words: ${words.join(', ')}</p><pre style="font-family:monospace;">${grid}</pre>`;
                    answers.push(`Words: ${words.join(', ')}`);
                } else if (type === 'Quiz') {
                    const questions = this.generateQuizQuestions(subject, theme, difficulty, 5);
                    questions.forEach((q, i) => {
                        content += `<div class="problem"><strong>${i+1}. ${q.question}</strong><br>${q.options.map((o, j) => `A${String.fromCharCode(65+j)}) ${o}`).join('<br>')}</div>`;
                        answers.push(`${i+1}. ${q.answer}`);
                    });
                }
                content += `<div class="answer-key"><h4>Answer Key:</h4><ol>${answers.map(a => `<li>${a}</li>`).join('')}</ol></div>`;
                this.elements.output.innerHTML = content;
                this.elements.output.style.display = 'block';
                this.elements.pdfBtn.style.display = 'inline-block';
                this.confetti();
            },
            generateGrid: function(words, size) {
                let grid = Array(size).fill().map(() => Array(size).fill(' '));
                words.forEach(word => {
                    const len = word.length;
                    const row = Math.floor(Math.random() * (size - len + 1));
                    const col = Math.floor(Math.random() * (size - len + 1));
                    for (let i = 0; i < len; i++) {
                        grid[row][col + i] = word[i];
                    }
                });
                for (let i = 0; i < size; i++) {
                    for (let j = 0; j < size; j++) {
                        if (grid[i][j] === ' ') grid[i][j] = String.fromCharCode(65 + Math.random() * 26);
                    }
                }
                return grid.map(row => row.join(' ')).join('\n');
            },
            generateQuizQuestions: function(subject, theme, difficulty, num) {
                const scienceFacts = { 
                    Space: ['What orbits Earth? A) Moon B) Sun C) Star', 'Moon'], 
                    Animals: ['King of jungle? A) Lion B) Tiger C) Bear', 'Lion'],
                    Undersea: ['Largest sea animal? A) Whale B) Shark C) Octopus', 'Whale'],
                    Dinos: ['Famous dino? A) T-Rex B) Lion C) Whale', 'T-Rex'],
                    Nature: ['What do trees need? A) Water B) Candy C) Rocks', 'Water'],
                    Transport: ['Fastest transport? A) Plane B) Car C) Bike', 'Plane']
                };
                const readingVocab = { 
                    Space: ['Group of stars? A) Galaxy B) Planet C) Rocket', 'Galaxy'],
                    Animals: ['Animal home? A) Habitat B) House C) School', 'Habitat'],
                    Undersea: ['Sea plant? A) Coral B) Tree C) Flower', 'Coral'],
                    Dinos: ['Dino era? A) Jurassic B) Modern C) Future', 'Jurassic'],
                    Nature: ['Season change? A) Fall B) Run C) Jump', 'Fall'],
                    Transport: ['Vehicle on water? A) Boat B) Car C) Train', 'Boat']
                };
                const qBank = subject === 'Science' ? (scienceFacts[theme] || ['Sample science Q', 'A']) : (readingVocab[theme] || ['Sample reading Q', 'A']);
                const options = [qBank[0].split('?')[0] + '?', qBank[0].split('?')[0] + '? B) Wrong', qBank[0].split('?')[0] + '? C) Another'];
                return Array.from({length: num}, (_, i) => ({
                    question: qBank[0] || `${theme} ${subject.toLowerCase()} fact?`,
                    options: options,
                    answer: qBank[1] || 'A'
                }));
            },
            downloadPDF: function() {
                if (!this.elements.output.innerHTML.trim()) {
                    alert('No worksheet generated yet! Hit Generate first, then download. üì•');
                    return;
                }
                const element = this.elements.output;
                const opt = {
                    margin: 1,
                    filename: `EduSheet_${this.elements.grade.value}_${this.elements.subject.value}_${this.elements.type.value}_${this.elements.theme.value || 'General'}_${this.elements.difficulty.value || 'Easy'}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(element).save();
                this.confetti();
            },
            confetti: function() {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            },
            saveTemplate: function() {
                if (!this.pristine.validate()) return;
                const template = {
                    grade: this.elements.grade.value,
                    subject: this.elements.subject.value,
                    type: this.elements.type.value,
                    theme: this.elements.theme.value,
                    difficulty: this.elements.difficulty.value
                };
                localStorage.setItem('edusheetTemplate', JSON.stringify(template));
            },
            loadTemplate: function() {
                const saved = localStorage.getItem('edusheetTemplate');
                if (saved) {
                    const template = JSON.parse(saved);
                    Object.keys(template).forEach(key => {
                        if (this.elements[key]) this.elements[key].value = template[key];
                    });
                    this.updatePreview();
                }
            },
            validateQuiz: function() {
                const allAnswered = ['q1', 'q2', 'q3', 'q4', 'q5'].every(q => this.state.quizAnswers[q]);
                const btn = document.getElementById('quizBtn');
                const error = document.getElementById('quiz-error');
                btn.disabled = !allAnswered;
                error.classList.toggle('show', !allAnswered);
            }
        };

        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === ['generator', 'assessment', 'library'].indexOf(sectionId));
                btn.setAttribute('aria-selected', i === ['generator', 'assessment', 'library'].indexOf(sectionId));
            });
        }

        function handleQuiz() {
            if (!['q1', 'q2', 'q3', 'q4', 'q5'].every(q => App.state.quizAnswers[q])) {
                alert('Please answer every question to get your personalized learning style results! üåü');
                return;
            }
            const scores = { visual: 0, auditory: 0, kinesthetic: 0 };
            ['q1', 'q2', 'q3', 'q4', 'q5'].forEach(q => {
                const ans = App.state.quizAnswers[q];
                if (ans) scores[ans]++;
            });
            const style = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            const recs = {
                visual: 'Visual learner! Try Space quizzes with diagrams or Nature word searches. Use colors in math practice! üëÅÔ∏è',
                auditory: 'Auditory learner! Listen to Animal stories on YouTube or TED-Ed riddles. Read aloud transport tales! üëÇ',
                kinesthetic: 'Kinesthetic learner! Hands-on Dinos math (build models) or Undersea experiments. Move during quizzes! ‚úã'
            };
            document.getElementById('results').innerHTML = `<h3>Your Style: ${style.charAt(0).toUpperCase() + style.slice(1)}!</h3><p>${recs[style]}</p>`;
            document.getElementById('results').style.display = 'block';
            document.getElementById('quiz').style.display = 'none';
            document.getElementById('quizBtn').style.display = 'none';
            document.getElementById('quiz-error').style.display = 'none';
        }

        function resetQuiz() {
            document.getElementById('quiz').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('quizBtn').style.display = 'inline-block';
            document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            App.state.quizAnswers = {};
            App.validateQuiz();
        }

        function filterResources() {
            const query = document.getElementById('search').value.toLowerCase().trim();
            document.querySelectorAll('.card').forEach(card => {
                const text = card.textContent.toLowerCase();
                const tags = card.dataset.tags.toLowerCase();
                card.style.display = (text.includes(query) || tags.includes(query)) ? 'block' : 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
